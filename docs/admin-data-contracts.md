# Admin Console Data Contracts

These contracts describe the backend models, relationships, and API shapes required to power the Admin Console pages outlined in the README. They assume the Gadget app exposes each entity through the autogenerated API (`context.api.<model>`) and that the `@gadgetinc/react` client consumes them through `useFindMany`, `useAction`, and friends.

For every section you will find:
- **Primary models** with required fields and relationships
- **Common queries** used to populate list/detail views
- **Mutations/actions** needed for CRUD flows
- **Notes** about aggregations, derived metrics, or external integrations

> All timestamps use ISO-8601 strings in UTC. Monetary amounts are stored in minor units (cents) and formatted in the UI.

---

## 1. Organizations & Tenancy

### Models
| Model | Fields | Notes |
| --- | --- | --- |
| `organization` | `id`, `name`, `slug`, `status` (`active`\|`suspended`\|`archived`), `createdAt`, `updatedAt` | Root entity representing a merchant or vendor org |
| `workspace` | `id`, `organization` (belongsTo), `label`, `environment` (`dev`\|`staging`\|`prod`), `domains[]`, `createdAt` | Multiple workspaces per org |
| `membership` | `id`, `organization`, `user`, `roles[]`, `invitedBy`, `invitedAt`, `acceptedAt`, `status` (`pending`\|`active`\|`revoked`) | Connects users to orgs |
| `tenantRole` | `id`, `key`, `label`, `description`, `scopes[]`, `default` (boolean) | Library of roles assignable within an org |

### Queries
```ts
const organizations = await api.organization.findMany({
  select: {
    id: true,
    name: true,
    slug: true,
    status: true,
    createdAt: true,
    memberships: {
      aggregate: { count: true },
    },
    workspaces: {
      select: { id: true, label: true, environment: true },
    },
  },
  sort: { createdAt: "Descending" },
});
```

### Actions
- `organization.create/update/delete`
- `membership.invite` (creates pending membership + send email)
- `membership.updateRoles`
- `membership.revoke`

### Notes
- Maintain derived counts (pending invites, active users, workspace totals) via aggregation queries.
- Audit changes via `auditEvent` model (see section 10).

---

## 2. Users & Teams

### Models
Reuse `user` (Gadget default) + `membership`.

### Queries
```ts
await api.user.findMany({
  select: {
    id: true,
    firstName: true,
    lastName: true,
    email: true,
    emailVerified: true,
    roles: true,
    memberships: {
      select: { organization: { name: true }, roles: true },
    },
    lastSignInAt: true,
  },
  sort: { lastSignInAt: "Descending" },
});
```

### Actions
- `user.invite` (optional wrapper around membership)
- `user.updateRoles` (updates global roles such as `admin`)
- `membership.update` (org-specific roles)

### Notes
- Display both global Gadget roles (used for RBAC) and tenant roles per organization.
- Provide status badges: verified vs unverified, active vs suspended (from `user.status`).

---

## 3. Roles & Permissions (RBAC)

### Models
| Model | Fields | Notes |
| --- | --- | --- |
| `role` | `name`, `label`, `description`, `default` | Global Gadget role definition |
| `roleGrant` | `id`, `roleName`, `model`, `action`, `filter` | Derived from `accessControl/permissions.gadget.ts` |
| `featureFlag` | `key`, `label`, `description`, `enabledRoles[]` | Toggles per role |

### Queries
- Read the permissions metadata from `permissions.gadget.ts` (load via import) and hydrate into table rows.
- `featureFlag` list with `enabledRoles` arrays.

### Actions
- `featureFlag.update` to toggle roles.
- Optional custom action `role.sync` to update Gadget permissions programmatically.

### Notes
- Keep permissions read-only unless you support editing the Gadget metadata locally.
- Provide download/export of current grants for audit.

---

## 4. Integration Registry

### Models
| Model | Fields | Notes |
| --- | --- | --- |
| `integration` | `id`, `type` (`marketplace`\|`courier`\|`printer`), `provider`, `label`, `status`, `scopes[]`, `metadata` (JSON), `createdAt`, `updatedAt` |
| `integrationCredential` | `id`, `integration`, `env`, `clientId`, `expiresAt`, `status`, `lastRotatedAt`, `owner` | Sensitive; stored encrypted |
| `webhookEndpoint` | `id`, `integration`, `url`, `status`, `lastEventAt`, `secretMasked` |

### Queries
```ts
await api.integration.findMany({
  select: {
    id: true,
    provider: true,
    label: true,
    type: true,
    status: true,
    createdAt: true,
    integrationCredentials: {
      select: { id: true, env: true, status: true, expiresAt: true },
    },
    webhookEndpoints: {
      select: { id: true, url: true, status: true, lastEventAt: true },
    },
  },
});
```

### Actions
- `integration.create/update`
- `integrationCredential.rotate`
- `webhookEndpoint.ping`

### Notes
- Mask secrets client-side. Provide copy-to-clipboard for public keys, not private secrets.

---

## 5. Secrets Vault

### Models
| Model | Fields | Notes |
| --- | --- | --- |
| `secret` | `id`, `key`, `environment`, `description`, `lastRotatedAt`, `createdBy`, `version`, `status` (`active`\|`retired`) |
| `secretVersion` | `id`, `secret`, `createdAt`, `createdBy`, `checksum`, `notes` |

### Queries
```ts
await api.secret.findMany({
  select: {
    id: true,
    key: true,
    environment: true,
    status: true,
    version: true,
    lastRotatedAt: true,
    createdBy: { id: true, firstName: true, lastName: true },
  },
});
```

### Actions
- `secret.create`
- `secret.rotate` (creates `secretVersion` + updates metadata)
- `secret.revoke`

### Notes
- Store secret material encrypted; UI never renders raw values post-creation.
- Enforce multi-step confirmation for destructive actions.

---

## 6. Catalog Schema & Validation

### Models
| Model | Fields | Notes |
| --- | --- | --- |
| `catalogAttribute` | `id`, `namespace`, `key`, `label`, `type` (`string`\|`number`\|`enum`\|`boolean`\|`json`), `required`, `unique`, `validationRule` (JSON), `version`, `status` |
| `attributeOption` | `id`, `catalogAttribute`, `value`, `label`, `sortOrder` |
| `schemaChange` | `id`, `attribute`, `changeType`, `proposedBy`, `approvedBy`, `approvedAt`, `status` |
| `validationError` | `id`, `product`, `catalogAttribute`, `message`, `source` (`ingestion`\|`channel`), `createdAt` |

### Queries
- Attribute list with latest version and counts of products impacted by validation errors.
- Validation error table grouped by attribute.

### Actions
- `catalogAttribute.create/update/delete`
- `schemaChange.approve/reject`

### Notes
- Provide diff view when editing attributes.
- Hook automation to block publishing when `validationError` count passes threshold.

---

## 7. Print Profiles & Jigs

### Models
| Model | Fields | Notes |
| --- | --- | --- |
| `printerDevice` | `id`, `vendor`, `model`, `serial`, `status`, `location`, `supportedMaterials[]`, `lastCalibrationAt` |
| `printProfile` | `id`, `printerDevice`, `name`, `substrate`, `resolution`, `colorProfile`, `lastValidatedAt`, `owner`, `version` |
| `jigTemplate` | `id`, `printerDevice`, `label`, `bedSize`, `alignmentGuide`, `fileUrl`, `approvedSampleUrl`, `status` |
| `calibrationRun` | `id`, `printerDevice`, `performedAt`, `performedBy`, `notes`, `measurements` (JSON) |

### Queries
- Table summarizing devices with `printProfile` counts and last calibration.
- Detail view listing profiles + jigs.

### Actions
- `printProfile.create/update`
- `jigTemplate.upload`
- `calibrationRun.create`

### Notes
- Provide download links for template/asset files.
- Attach QA approvals and golden sample references.

---

## 8. Routing & SLA Policies

### Models
| Model | Fields | Notes |
| --- | --- | --- |
| `routingPolicy` | `id`, `name`, `status`, `effectiveAt`, `description`, `createdBy`, `updatedAt` |
| `routingRule` | `id`, `routingPolicy`, `priority`, `criteria` (JSON DSL), `weights` (JSON), `fallbackPolicy` |
| `slaTarget` | `id`, `routingPolicy`, `metric`, `targetValue`, `unit`, `threshold`, `warningThreshold` |
| `routingSimulation` | `id`, `routingPolicy`, `scenario`, `results` (JSON), `createdAt` |

### Queries
- Active policy with associated rules and SLA targets.
- Historical list of policies with status `draft`\|`active`\|`retired`.

### Actions
- `routingPolicy.create/update/activate/retire`
- `routingSimulation.run`

### Notes
- Use simulation results to preview impact before activation.
- Provide YAML/JSON export for external review.

---

## 9. Finance Configuration

### Models
| Model | Fields | Notes |
| --- | --- | --- |
| `financeConfig` | `id`, `name`, `status`, `createdAt`, `updatedAt`, `appliesTo` (`vendor` ID list or `all`), `effectiveAt` |
| `feeRule` | `id`, `financeConfig`, `type` (`commission`\|`processing`\|`service`), `rate`, `basis` (`percentage`\|`flat`), `min`, `max`, `currency` |
| `taxRule` | `id`, `financeConfig`, `jurisdiction`, `rate`, `taxType`, `notes` |
| `payoutSchedule` | `id`, `financeConfig`, `frequency`, `offsetDays`, `cutoffTime`, `timeZone` |

### Queries
- Current finance configuration and associated rules.
- Change history to compare versions.

### Actions
- `financeConfig.create/draft`
- `financeConfig.publish`
- `feeRule.create/update/delete`

### Notes
- Track approvals (who published, when). Integrate with `auditEvent`.

---

## 10. Observability

### Models
| Model | Fields | Notes |
| --- | --- | --- |
| `serviceMetric` | `id`, `serviceName`, `metric`, `currentValue`, `target`, `unit`, `direction` (`up`\|`down`), `capturedAt` |
| `alert` | `id`, `serviceName`, `type`, `severity`, `status`, `openedAt`, `acknowledgedAt`, `resolvedAt`, `runbookUrl` |
| `incident` | `id`, `title`, `status`, `severity`, `startedAt`, `resolvedAt`, `summary`, `postmortemUrl` |
| `logForwarder` | `id`, `destination`, `status`, `lastHeartbeatAt` |

### Queries
- Dashboard fetch with top metrics + open alerts/incidents.
- Drill-down fetch per service for detailed charts (handled client-side).

### Actions
- `alert.acknowledge/resolve`
- `incident.create/update`

### Notes
- Plug metrics into external provider (Grafana/Datadog) via ingestion endpoints.
- Provide links to runbooks and dashboards.

---

## 11. Audit & Reports

### Models
| Model | Fields | Notes |
| --- | --- | --- |
| `auditEvent` | `id`, `actor` (user), `action`, `resourceType`, `resourceId`, `changes` (JSON diff), `context` (IP, user agent), `createdAt` |
| `reportDefinition` | `id`, `name`, `category`, `description`, `schedule` (`manual`\|`daily`\|`weekly`), `format`, `parameters` (JSON), `createdAt` |
| `reportRun` | `id`, `reportDefinition`, `status`, `requestedBy`, `startedAt`, `completedAt`, `storageUrl`, `error` |

### Queries
- Paginated audit log sorted by `createdAt` descending with filters on actor, action, date range.
- Report definitions with latest run metadata.

### Actions
- `reportRun.trigger`
- `reportDefinition.create/update`

### Notes
- Provide download links for completed runs (signed URLs).
- Allow exporting filtered audit logs as CSV.

---

## 12. Cross-Cutting Concerns

- **Authorization**: enforce via Gadget `permissions.gadget.ts`. Use `useAction`/`useFindMany` handlers with role filters.
- **Search/Filtering**: support `search` (full-text) and `filter` (structured) props in `AutoTable` to match the contracts above.
- **Metrics & Aggregations**: prefer backend computed aggregates (using Gadget aggregates) to minimize client processing.
- **Auditability**: all mutations should append an `auditEvent`. Include mutation metadata in the UI for quick review.
- **Error Handling**: surface toast notifications (`sonner`) with actionable messages when actions fail.

---

## Next Steps
1. Implement/extend Gadget models to match the schemas above (or adjust the contract to fit existing data).
2. Replace the checklist cards in each admin route with `AutoTable` or custom data visualizations powered by these queries.
3. Add corresponding actions (create/update/delete) to the UI components, ensuring each mutation triggers toast feedback and revalidation.
4. Wire role-based access (already added to the nav) to protect each admin feature based on `admin` role membership.

